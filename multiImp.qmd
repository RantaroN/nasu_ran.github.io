---
title: "多重代入法について"
author: "那須蘭太郎"
format:
  html:
    toc: true
    toc_float: true
    
---

# 本資料について

1. 本資料は，『欠測データ処理 : Rによる単一代入法と多重代入法』（高橋将宜・渡辺美智子著）をもとにして作成されています．
2. 私の理解不足により，内容に誤りがございましたら，ご一報いただけますと幸いです．
3. あくまでも，個人的な備忘録として作成しております．

以上，ご了承ください．

# 【理論】

# 【実践】
## 分析下準備

パッケージのインストールとデータの準備

```{r}
#install.packages("mice")
library(mice)

data("iris")
```

他に必要なパッケージも準備

```{r}
library(dplyr)
library(tibble)
library(tidyr)
```

## データの確認

```{r}
summary(iris)
```

irisデータには，欠損値が含まれないため，このirisの完全データをcompとして保存し，ランダムに欠損を発生させたデータをmissとして保存．

## 完全データの保存
```{r}
comp <- iris %>% rowid_to_column("id")
```

## ランダムに欠損を発生させる
```{r}
miss <- iris %>% rowid_to_column("id")
variable <- "Sepal.Length" # 欠損を発生させる変数を選択
missing_rate <- 0.1  # 欠損割合（10%）
num_missing <- ceiling(nrow(miss) * missing_rate) #欠損数の計算
missing_indices <- sample(1:nrow(miss),
                          num_missing,
                          replace = FALSE) # 欠損を発生させる観測値のインデックスをランダムに選択
miss[missing_indices, variable] <- NA #欠損を発生させる

table(is.na(miss$Sepal.Length)) # 欠損数の確認
miss_num <- which(is.na(miss$Sepal.Length)) #欠損となったデータの行番号（この後使う）
miss_num
```
irisの"Sepal.Length"に，15（全体の10%）の欠損ができた．

## miceによる多重代入法
### 通常のデータ形式
次に，このmissデータを使用して多重代入法による欠損値の補完を行う．miceパッケージのmice関数によって補完．
```{r}
imp <- mice(data = miss, # 欠損値を含むデータを指定
            m = 5, # 多重代入済みデータ数を指定
            seed = 1234, # 任意のシード値を指定
            method = "norm", # 代入モデルを指定
            maxit = 5 # 並列連鎖データ拡大法の長さTを指定
            )
```
これで，多重代入は完了．次に，この多重代入データの中身を確認する．
miceのcomplete()を使用することで，多重代入済みデータの中身を確認することができる．

:::{.panel-tabset}
#### m=1
```{r}
complete(imp,1) %>% # impは多重代入済みデータ名，第2引数では何番目の多重代入済みデータかを指定．
  slice(miss_num) # 欠損していた行のみを表示
```
#### m=2
```{r}
complete(imp,2) %>% # impは多重代入済みデータ名，第2引数では何番目の多重代入済みデータかを指定．
  slice(miss_num) # 欠損していた行のみを表示
```
#### m=3
```{r}
complete(imp,3) %>% # impは多重代入済みデータ名，第2引数では何番目の多重代入済みデータかを指定．
  slice(miss_num) # 欠損していた行のみを表示
```
#### m=4
```{r}
complete(imp,4) %>% # impは多重代入済みデータ名，第2引数では何番目の多重代入済みデータかを指定．
  slice(miss_num) # 欠損していた行のみを表示
```
#### m=5
```{r}
complete(imp,5) %>% # impは多重代入済みデータ名，第2引数では何番目の多重代入済みデータかを指定．
  slice(miss_num) # 欠損していた行のみを表示
```
:::

### パネルデータ形式
```{r}
```

## 多重代入データの確認
```{r}
```

## 多重代入データを使用した多変量解析
### 線形従属変数のモデリング
```{r}
```

### 順序従属変数のモデリング
```{r}
```

### カテゴリカル従属変数のモデリング
```{r}
```

### パネルデータに対数モデリング
```{r}
```

